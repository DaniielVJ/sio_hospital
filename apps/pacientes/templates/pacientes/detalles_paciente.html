{% extends "base.html" %}
{% load static %}

{% block title %}
    Ficha del Paciente
{% endblock title %}

{% block estilos_personalizados %}
    <link rel="stylesheet" href="{% static 'styles/toastify.min.css' %}">
    <link rel="stylesheet" href="{% static 'styles/detail.css' %}">
    <link rel="stylesheet" href="{% static 'styles/form.css' %}">
    <link rel="stylesheet" href="{% static 'styles/cards.css' %}">
{% endblock estilos_personalizados %}

{% block menus_navegacion %}
    {% include 'includes/topbar.html' %}
    {% include 'includes/sidebar.html' %}
{% endblock menus_navegacion %}

{% block content %}
    <main class="main-container main-content-detail">

        <nav class="breadcrumbs breadcrumbs-margin">
            <a href="{% url 'pantalla_principal' %}" class="link-color">Inicio</a> <span>‚Ä∫</span>
            <a href="{% url 'paciente:inicio' %}" class="link-color">Pacientes</a> <span>‚Ä∫</span>
            <span>Ficha Cl√≠nica #{{ object.pk }}</span>
        </nav>

        <div class="layout-grid">
            
            <div class="cards-container detail-flow"> 
                
                <div class="form-header">
                    <h2 class="form-title">Ficha Cl√≠nica de Paciente</h2>
                    <div class="form-subtitle">
                        <span class="chip-dato active">{{ object.tipo_paciente|default:"General" }}</span> 
                        <span class="ficha-id-number">RUT: {{ object.identificacion }}</span> 
                    </div>
                </div>

                <div class="details-form-wrapper">
                    
                    <div class="section-header">
                        <h3 class="section-title">1. Identificaci√≥n Personal</h3>
                    </div>
                    
                    <div class="detalle-grid-3">
                        <div class="dato-box">
                            <span class="dato-label">Nombre Completo</span>
                            <span class="dato-valor">{{ object.nombre }} {{ object.apellido_paterno }} {{ object.apellido_materno }}</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Fecha Nacimiento</span>
                            <span class="dato-valor">{{ object.fecha_nacimiento|date:"d/m/Y" }}</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Edad Actual</span>
                            <span class="dato-big">{{ object.calcular_edad }}</span>
                            <span class="dato-label" style="margin-top:0;">A√±os</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Nacionalidad</span>
                            <span class="dato-valor">{{ object.nacionalidad }}</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Previsi√≥n</span>
                            <span class="dato-valor">{{ object.prevision|default:"FONASA" }}</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Estado Civil</span>
                            <span class="dato-valor">{{ object.estado_civil|default:"No informado" }}</span>
                        </div>
                    </div>

                    <div class="section-header" style="margin-top: 2rem;">
                        <h3 class="section-title">2. Informaci√≥n de Contacto</h3>
                    </div>

                    <div class="detalle-grid-3">
                        <div class="dato-box">
                            <span class="dato-label">Tel√©fono M√≥vil</span>
                            <span class="dato-valor">{{ object.telefono|default:"-- --" }}</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Correo Electr√≥nico</span>
                            <span class="dato-valor">{{ object.email|default:"No registra" }}</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Comuna / Regi√≥n</span>
                            <span class="dato-valor">{{ object.comuna }}</span>
                        </div>
                    </div>
                    
                    <div class="detalle-grid-3" style="margin-top: 1rem; grid-template-columns: 1fr;">
                        <div class="dato-box" style="align-items: flex-start; text-align: left;">
                            <span class="dato-label">Direcci√≥n de Residencia</span>
                            <span class="dato-valor">{{ object.direccion }}</span>
                        </div>
                    </div>

                    <div class="section-header" style="margin-top: 2rem;">
                        <h3 class="section-title">3. Antecedentes M√≥rbidos y Alergias</h3>
                    </div>

                    <div class="detalle-grid-3">
                        <div class="dato-box">
                            <span class="dato-label">Grupo Sangu√≠neo</span>
                            <span class="dato-big" style="color: var(--primary);">{{ object.grupo_sanguineo|default:"--" }}</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Alergias</span>
                            <span class="dato-valor">{{ object.alergias|default:"Niega" }}</span>
                        </div>
                        <div class="dato-box">
                            <span class="dato-label">Enfermedades Cr√≥nicas</span>
                            <span class="dato-valor">{{ object.antecedentes_morbidos|default:"Sin antecedentes" }}</span>
                        </div>
                    </div>

                </div> <h3 class="audit-title" style="margin-top: 2rem;">Historial Cl√≠nico</h3>

                <details class="finexy-accordion" id="acc-gestaciones" open>
                    <summary class="finexy-summary">
                        <span>ü§∞ Historial de Gestaciones ({{ object.gestacion_set.count }})</span>
                    </summary>
                    <div class="accordion-content" id="content-gestaciones">
                        
                        {% if object.gestacion_set.exists %}
                            <div class="table-container" style="box-shadow: none; border: 1px solid var(--border-subtle); padding: 0;">
                                <table class="smart-table">
                                    <thead>
                                        <tr>
                                            <th>Fecha Ingreso</th>
                                            <th>Semanas</th>
                                            <th>Estado</th>
                                            <th>Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for gestacion in object.gestacion_set.all %}
                                        <tr>
                                            <td>{{ gestacion.created_at|date:"d/m/Y" }}</td>
                                            <td>{{ gestacion.semanas_gestacion }} sem</td>
                                            <td>
                                                <span class="role-badge" style="background:var(--bg-input);">{{ gestacion.estado|capfirst }}</span>
                                            </td>
                                            <td>
                                                <a href="{% url 'gestacion:detalle_gestacion' gestacion.pk %}" class="link-color" style="font-weight:600;">Ver Ficha</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div style="padding: 1.5rem; text-align: center; color: var(--text-muted);">
                                <p>No hay gestaciones registradas para esta paciente.</p>
                                <a href="{% url 'gestacion:agregar_gestacion' %}?paciente={{ object.pk }}" class="btn-primary" style="margin-top: 1rem; display: inline-block;">
                                    + Iniciar Gestaci√≥n
                                </a>
                            </div>
                        {% endif %}

                    </div>
                </details>

                <div class="form-actions detail-footer"> 
                    <a href="{% url 'paciente:eliminar_paciente' object.pk %}" class="btn-danger">
                        Eliminar Paciente
                    </a>

                    <div class="right-actions">
                        <a href="{% url 'paciente:inicio' %}" class="btn-secondary">Volver</a>
                        
                        <a href="{% url 'paciente:actualizar_paciente' object.pk %}" class="btn-primary">
                            Editar Datos Personales
                        </a>
                    </div>
                </div>

            </div> 
            
            <div class="dashboard-panel audit-panel"> 
                <h3 class="audit-title">Auditor√≠a de Ficha</h3> 
                
                <div class="stat-item">
                    <span class="stat-label">Ingresado por:</span>
                    <div class="audit-info-row"> 
                        <img src="{% static 'icons/matronaicon.png' %}" width="35" class="audit-photo" alt="Foto"> 
                        <div>
                            <span class="dato-valor audit-stat-value">
                                {{ object.created_by.get_full_name|default:object.created_by.username }}
                            </span> 
                            <span class="stat-label audit-stat-date">
                                üìÖ {{ object.created_at|date:"d/m/Y" }} ‚Ä¢ üïí {{ object.created_at|date:"H:i" }}
                            </span> 
                        </div>
                    </div>
                </div>

                <div class="stat-item">
                    <span class="stat-label">√öltima Actualizaci√≥n:</span>
                    <div class="audit-info-row"> 
                        <div class="audit-initials-pill">UP</div> 
                        <div>
                            <span class="dato-valor audit-stat-value">
                                {{ object.updated_by.get_full_name|default:"Sistema" }}
                            </span> 
                            <span class="stat-label audit-stat-date">
                                üìÖ {{ object.updated_at|date:"d/m/Y" }} ‚Ä¢ üïí {{ object.updated_at|date:"H:i" }}
                            </span> 
                        </div>
                    </div>
                </div>

                <div class="stat-item" style="margin-top: 1rem; border-top: 1px dashed var(--border-subtle); padding-top: 1rem;">
                    <span class="stat-label">Observaciones Administrativas</span>
                    <p class="audit-obs-text">
                        {{ object.observaciones|default:"Paciente ingresada correctamente al sistema. Sin observaciones administrativas pendientes." }}
                    </p>
                </div>

            </div> 

        </div> 

    </main>
{% endblock content %}

{% block scripts %}
    <script src="{% static 'js/toastify.min.js' %}"></script>
    <script>
        // Script simple para confirmar eliminaci√≥n si no usas un modal complejo
        const deleteBtn = document.querySelector('.btn-danger');
        if(deleteBtn) {
            deleteBtn.addEventListener('click', function(e) {
                if(!confirm('¬øEst√°s seguro de eliminar la ficha de esta paciente? Se perder√° todo el historial.')) {
                    e.preventDefault();
                }
            });
        }
    </script>
{% endblock scripts %}